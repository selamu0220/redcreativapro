"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8794],{8794:(e,r,t)=>{t.d(r,{A:()=>n,AuthProvider:()=>o});var i=t(95155),s=t(12115),a=t(93536);let l=(0,s.createContext)(void 0),o=e=>{let{children:r}=e,[t,o]=(0,s.useState)(null),[n,u]=(0,s.useState)(!0),[d,c]=(0,s.useState)(!1),[m,p]=(0,s.useState)(null);console.log("AuthProvider: Rendering with loading:",n,"user:",t?"exists":"null");let f=(0,s.useCallback)(async e=>{try{var r,t,i,s,l;let n;if(u(!0),console.log("Loading profile for user:",e.id),!a.N)return void console.error("Supabase client not initialized");let d=a.N.from("users").select("*").eq("id",e.id).single(),c=new Promise((e,r)=>setTimeout(()=>r(Error("Profile query timeout")),5e3)),{data:m,error:p}=await Promise.race([d,c]);if(console.log("Profile query result:",{profile:m,error:p}),p)if("PGRST116"===p.code)console.log("No existing profile found for user, will create new one");else if("42P01"===p.code){console.error("Users table does not exist in Supabase database. Please run the database migrations."),console.log("Creating temporary profile due to missing table");let i={id:e.id,email:e.email||"",full_name:(null==(r=e.user_metadata)?void 0:r.full_name)||(null==(t=e.email)?void 0:t.split("@")[0])||"Usuario",subscription_tier:"free",subscription_end_date:null},s={id:i.id,email:i.email,name:i.full_name,subscriptionType:i.subscription_tier,subscriptionEndDate:i.subscription_end_date?new Date(i.subscription_end_date):null,dailyUsage:{date:new Date().toISOString().split("T")[0],aiRequests:0,promptsUsed:0,scriptsGenerated:0},dailyLimits:{aiRequests:100,promptsUsed:20,scriptsGenerated:5}};o(s);return}else{if("42501"===p.code)return void console.error("Insufficient privileges to access users table. Please check RLS policies.");if("Profile query timeout"!==p.message)return void console.error("Error loading profile:",{message:p.message,code:p.code,details:p.details,hint:p.hint,fullError:p});console.error("Profile query timed out - database may be slow or unavailable");let r={id:e.id,email:e.email||"",full_name:(null==(i=e.user_metadata)?void 0:i.full_name)||(null==(s=e.email)?void 0:s.split("@")[0])||"Usuario",subscription_tier:"free",subscription_end_date:null},t={id:r.id,email:r.email,name:r.full_name,subscriptionType:r.subscription_tier,subscriptionEndDate:r.subscription_end_date?new Date(r.subscription_end_date):null,dailyUsage:{date:new Date().toISOString().split("T")[0],aiRequests:0,promptsUsed:0,scriptsGenerated:0},dailyLimits:{aiRequests:100,promptsUsed:20,scriptsGenerated:5}};o(t);return}if(m)n=m;else{let r={id:e.id,email:e.email,full_name:(null==(l=e.user_metadata)?void 0:l.full_name)||e.email.split("@")[0],subscription_tier:"free",subscription_status:"free",subscription_end_date:null},{data:t,error:i}=await a.N.from("users").insert(r).select().single();if(i)return void console.error("Error creating profile:",{message:i.message,code:i.code,details:i.details,hint:i.hint,fullError:i});n=t}let f={id:n.id,email:n.email,name:n.full_name,subscriptionType:n.subscription_tier,subscriptionEndDate:n.subscription_end_date?new Date(n.subscription_end_date):null,dailyUsage:{date:new Date().toISOString().split("T")[0],aiRequests:0,promptsUsed:0,scriptsGenerated:0},dailyLimits:{aiRequests:100,promptsUsed:20,scriptsGenerated:5}};o(f)}catch(e){console.error("Error in loadUserProfile:",{message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0,fullError:e}),o(null)}finally{u(!1)}},[]);(0,s.useEffect)(()=>{(async()=>{try{let e=localStorage.getItem("demo_auth"),r=localStorage.getItem("demo_user");if("true"===e&&r)try{let e=JSON.parse(r);o(e),u(!1),console.log("AuthProvider: Demo mode initialized with user:",e);return}catch(e){console.error("Error parsing demo user:",e),localStorage.removeItem("demo_auth"),localStorage.removeItem("demo_user")}let{data:{session:t}}=await a.N.auth.getSession();if(null==t?void 0:t.user)try{await f(t.user)}catch(e){console.error("Error loading user profile on session check:",e)}}catch(e){console.error("Error initializing auth:",e)}finally{u(!1)}})();let{data:{subscription:e}}=a.N.auth.onAuthStateChange(async(e,r)=>{if("SIGNED_IN"===e&&(null==r?void 0:r.user))try{await f(r.user),c(!1),p(null)}catch(e){console.error("Error loading user profile on auth change:",e)}else"SIGNED_OUT"===e&&(o(null),c(!1),p(null))});return()=>e.unsubscribe()},[f]);let g=(0,s.useCallback)(()=>!!t&&("free"===t.subscriptionType||!t.subscriptionEndDate||new Date<t.subscriptionEndDate),[t]),b=(0,s.useCallback)(()=>{if(!t||!t.subscriptionEndDate)return 0;let e=new Date;return Math.max(0,Math.ceil((t.subscriptionEndDate.getTime()-e.getTime())/864e5))},[t]),_=(0,s.useCallback)(async(e,r)=>{try{let{data:t,error:i}=await a.N.auth.signInWithPassword({email:e,password:r});if(i){if(i.message.includes("Email not confirmed"))throw c(!0),p(e),Error("Email not confirmed");if(i.message.includes("Invalid login credentials"))throw Error("Invalid login credentials");throw i}t.user&&(c(!1),p(null),await f(t.user))}catch(e){throw console.error("Login error:",e),Error(e.message||"Error al iniciar sesi\xf3n")}},[f]),h=(0,s.useCallback)(async()=>{try{let e=localStorage.getItem("demo_auth");if("true"===e){localStorage.removeItem("demo_auth"),localStorage.removeItem("demo_user"),o(null);return}let{error:r}=await a.N.auth.signOut();if(r)throw r;o(null)}catch(e){throw console.error("Logout error:",e),Error(e.message||"Error al cerrar sesi\xf3n")}},[]),y=(0,s.useCallback)(async(e,r,t)=>{try{let{data:i,error:s}=await a.N.auth.signUp({email:e,password:r,options:{data:{full_name:t}}});if(s)throw s;console.log("Signup successful, verification email sent to:",e),c(!0),p(e),i.user&&i.user.email_confirmed_at&&(await f(i.user),c(!1),p(null))}catch(e){throw console.error("Signup error:",e),Error(e.message||"Error al crear la cuenta")}},[f]),E=(0,s.useCallback)((e,r)=>{t&&(o(t=>{if(!t)return null;let i={...t,subscriptionType:e,subscriptionEndDate:r||null};return a.N.from("users").update({subscription_tier:e,subscription_status:"free"===e?"free":"active"}).eq("id",t.id).then(e=>{let{error:r}=e;r&&console.error("Error updating subscription:",r)}),i}),window.dispatchEvent(new CustomEvent("subscriptionUpdated",{detail:{subscriptionType:e,endDate:r}})))},[t]),w=(0,s.useCallback)(()=>{c(!1),p(null)},[]),S=(0,s.useCallback)(e=>{if(!t)return 0;let r=new Date().toISOString().split("T")[0];return t.dailyUsage.date!==r?(o(e=>e?{...e,dailyUsage:{date:r,aiRequests:0,promptsUsed:0,scriptsGenerated:0}}:null),t.dailyLimits[e]):Math.max(0,t.dailyLimits[e]-t.dailyUsage[e])},[t]),v=(0,s.useCallback)(e=>{if(!t)return;let r=new Date().toISOString().split("T")[0];o(t=>t?t.dailyUsage.date!==r?{...t,dailyUsage:{date:r,aiRequests:+("aiRequests"===e),promptsUsed:+("promptsUsed"===e),scriptsGenerated:+("scriptsGenerated"===e)}}:{...t,dailyUsage:{...t.dailyUsage,[e]:t.dailyUsage[e]+1}}:null)},[t]),U=(0,s.useCallback)(e=>{if(!t)return!1;if("free"!==t.subscriptionType)return!0;let r=new Date().toISOString().split("T")[0];return t.dailyUsage.date!==r||t.dailyUsage[e]<t.dailyLimits[e]},[t]);return(0,i.jsx)(l.Provider,{value:{user:t,loading:n,isAuthenticated:!!t,needsEmailVerification:d,pendingVerificationEmail:m,login:_,logout:h,signup:y,hasActiveSubscription:g,getRemainingSubscriptionDays:b,updateSubscriptionStatus:E,clearEmailVerification:w,getRemainingUsage:S,incrementUsage:v,canUseFeature:U},children:r})},n=()=>{let e=(0,s.useContext)(l);if(void 0===e)throw Error("useAuth debe ser usado dentro de un AuthProvider");return e}},93536:(e,r,t)=>{t.d(r,{N:()=>l});var i=t(34060);let s="https://orqbkacsbpbybmnaabzo.supabase.co",a="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ycWJrYWNzYnBieWJtbmFhYnpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkxNTAxMDYsImV4cCI6MjA2NDcyNjEwNn0.5P7z_rOneANw9OZl8eoml5h4s4QtpcfCYy-FVL_uU2s";if(!s||!a)throw Error("Supabase environment variables NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY are missing. Please check your .env file or environment configuration.");let l=(0,i.UU)(s,a)}}]);